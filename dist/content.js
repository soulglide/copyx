let r="",y=Date.now();const h=1e3;let u=[];console.log("CopyX: content.ts loaded. Version 2.0");const C=()=>{browser.storage.local.get("snippets",e=>{e.snippets&&(u=e.snippets,console.log("CopyX: Snippets loaded into cache.",u))})};C();browser.storage.onChanged.addListener((e,s)=>{s==="local"&&e.snippets&&(console.log("CopyX: Snippets have changed, reloading cache."),C())});document.addEventListener("keydown",async e=>{const s=document.activeElement;if(!s)return;if(!(s.tagName==="INPUT"&&s.type==="text"||s.tagName==="TEXTAREA"||s.isContentEditable)){r="";return}if(e.key==="Shift"||e.key==="Control"||e.key==="Alt"||e.key==="Meta"||e.key==="CapsLock")return;const t=e.key===" "||e.key==="Enter"||e.key==="Tab";if(Date.now()-y>h&&!t&&(r=""),y=Date.now(),!e.isComposing){if(t){if(r.length===0)return;e.preventDefault();const c=u.find(d=>d.shortcut===r);c&&await x(s,c,c.shortcut),r="";return}e.key==="Backspace"?r=r.slice(0,-1):e.key.length===1&&(r+=e.key)}});async function x(e,s,l){console.log(`CopyX: Replacing shortcut "${l}" in`,e);let t=s.snippet;const c=new Date;if(t=t.replace(/\${date}/g,c.toLocaleDateString()),t=t.replace(/\${time}/g,c.toLocaleTimeString()),t=t.replace(/\${datetime}/g,c.toLocaleString()),t.includes("${clipboard}"))try{const n=await navigator.clipboard.readText();t=t.replace("${clipboard}",n)}catch(n){console.error("CopyX: Failed to read clipboard contents: ",n)}const d="${cursor}",i=t.indexOf(d);if(t=t.replace(d,""),e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){const n=e.selectionEnd||0,o=e.value,a=n-l.length;if(a<0){console.error("CopyX: Error: shortcut not found immediately before the cursor.");return}const p=o.slice(0,a),g=o.slice(n);e.value=p+t+g;const f=p.length+(i!==-1?i:t.length);e.setSelectionRange(f,f),console.log("CopyX: Snippet inserted into input/textarea.")}else if(e.isContentEditable){console.log("CopyX: Inserting snippet into contenteditable element.");const n=window.getSelection();if(!n||n.rangeCount===0){console.error("CopyX: Cannot insert snippet, no selection found.");return}const o=n.getRangeAt(0);if(o.setStart(o.startContainer,o.startOffset-l.length),o.deleteContents(),i!==-1){const a=t.slice(0,i),p=t.slice(i),g=document.createTextNode(p),f=document.createTextNode(a);o.insertNode(g),o.insertNode(f),o.setStart(g,0),o.collapse(!0),n.removeAllRanges(),n.addRange(o)}else{const a=document.createTextNode(t);o.insertNode(a),o.setStartAfter(a),o.collapse(!0),n.removeAllRanges(),n.addRange(o)}console.log("CopyX: Snippet inserted into contenteditable.")}}
