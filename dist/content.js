let n="",d=Date.now();const y=1e3;console.log("CopyX: content.ts loaded.");document.addEventListener("keydown",async e=>{console.log("CopyX: Keydown event detected.",e.key,"Code:",e.code);const r=e.target;if(!(r.tagName==="INPUT"&&r.type==="text"||r.tagName==="TEXTAREA"||r.isContentEditable)){n="",console.log("CopyX: Not a text input. Buffer reset.");return}if(e.key==="Shift"||e.key==="Control"||e.key==="Alt"||e.key==="Meta"||e.key==="CapsLock"){console.log("CopyX: Modifier key pressed. Ignoring.");return}if(Date.now()-d>y&&(n="",console.log("CopyX: Debounce time exceeded. Buffer reset.")),d=Date.now(),e.key==="Backspace")n=n.slice(0,-1),console.log("CopyX: Backspace. Buffer:",n);else if(e.key===" "||e.key==="Enter"||e.key==="Tab"){n="",console.log("CopyX: Separator key. Buffer reset.");return}else if(e.key.length===1)n+=e.key,console.log("CopyX: Appended to buffer:",n);else{console.log("CopyX: Other non-character key. Not appending to buffer.");return}chrome.storage.sync.get("snippets",async l=>{if(console.log("CopyX: Fetched snippets from storage:",l.snippets),l.snippets){for(const t of l.snippets)if(n.endsWith(t.shortcut)){console.log("CopyX: Snippet match found!",t.shortcut),e.preventDefault(),await C(r,t),n="",console.log("CopyX: Snippet replaced. Buffer reset.");break}}})});async function C(e,r){console.log("CopyX: replaceText called with:",e,r);let a="",l=0;if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)a=e.value,e.selectionStart,l=e.selectionEnd||0;else if(e.isContentEditable){const o=window.getSelection();if(o&&o.rangeCount>0){const c=o.getRangeAt(0);a=e.innerText,c.startOffset,l=c.endOffset}}console.log("CopyX: Current text before replacement:",a);const t=a.slice(0,l-r.shortcut.length),p=a.slice(l);let s=r.snippet;if(s.includes("${clipboard}"))try{const o=await navigator.clipboard.readText();s=s.replace("${clipboard}",o),console.log("CopyX: Clipboard content inserted.")}catch(o){console.error("CopyX: Failed to read clipboard contents: ",o)}const i=s.indexOf("${cursor}");s=s.replace("${cursor}","");const f=t+s+p;if(console.log("CopyX: New text after replacement:",f),e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)if(e.value=f,i!==-1){const o=t.length+i;e.setSelectionRange(o,o),console.log("CopyX: Cursor set for input/textarea at:",o)}else e.setSelectionRange(t.length+s.length,t.length+s.length),console.log("CopyX: Cursor set for input/textarea at end.");else if(e.isContentEditable)if(e.innerText=f,i!==-1){const o=t.length+i,c=document.createRange(),g=window.getSelection();c.setStart(e.firstChild||e,o),c.collapse(!0),g?.removeAllRanges(),g?.addRange(c),console.log("CopyX: Cursor set for contenteditable at:",o)}else{const o=document.createRange(),c=window.getSelection();o.setStart(e.firstChild||e,t.length+s.length),o.collapse(!0),c?.removeAllRanges(),c?.addRange(o),console.log("CopyX: Cursor set for contenteditable at end.")}}
